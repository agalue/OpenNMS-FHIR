version: '3.7'

volumes:

  zookeeper:
  kafka:
  postgres:
  onms_rrd:
  onms_reports:
  onms_mibs:

services:

  zookeeper:
    image: zookeeper:3.4
    container_name: zookeeper
    hostname: zookeeper
    volumes:
    - zookeeper:/data
    environment:
    - TZ=America/New_York
    - ZOO_MY_ID=1
    - ZOO_SERVERS=server.1=zookeeper:2888:3888
    - JMXLOCALONLY=false
    - JMXDISABLE=false
    - JMXPORT=9998
    - JMXAUTH=false
    - JMXSSL=false
    healthcheck:
      test: echo stat | nc zookeeper 2181
      interval: 30s
      timeout: 5s
      retries: 3

  kafka:
    image: wurstmeister/kafka:2.12-2.4.1
    container_name: kafka
    hostname: kafka
    depends_on:
    - zookeeper
    volumes:
    - kafka:/kafka
    environment:
    - TZ=America/New_York
    - KAFKA_BROKER_ID=1
    - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://:9092
    - KAFKA_LISTENERS=PLAINTEXT://:9092
    - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181/kafka
    - KAFKA_NUM_PARTITIONS=1
    - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
    - KAFKA_DEFAULT_REPLICATION_FACTOR=1
    - KAFKA_MIN_INSYNC_REPLICAS=1
    - JMX_PORT=9999
    - KAFKA_JMX_OPTS=-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=kafka -Dcom.sun.management.jmxremote.rmi.port=9999
    ports:
    - 9092:9092
    healthcheck:
      test: nc -z localhost 9092
      interval: 30s
      timeout: 5s
      retries: 3

  manager:
    image: hlebalbau/kafka-manager:2.0.0.2
    container_name: manager
    hostname: manager
    depends_on:
    - kafka
    ports:
    - 9000:9000 
    environment:
    - TZ=America/New_York
    - ZK_HOSTS=zookeeper:2181
    healthcheck:
      test: wget --quiet --tries=1 --spider http://localhost:9000 || exit 1
      interval: 1m
      timeout: 5s
      retries: 3

  database:
    container_name: database
    hostname: database
    image: postgres:12
    volumes:
    - postgres:/var/lib/postgresql/data
    ports:
    - 5432:5432
    environment:
    - TZ=America/New_York
    - POSTGRES_HOST=database
    - POSTGRES_PORT=5432
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 5s
      retries: 3

  opennms:
    container_name: opennms
    hostname: opennms
    image: agalue/horizon:26.0.0 # To avoid NMS-12688
    depends_on:
    - database
    - kafka
    command: [ -s ]
    ports:
    - 8980:8980
    - 8101:8101
    volumes:
    - ./opennms-overlay:/opt/opennms-etc-overlay
    - onms_mibs:/opennms-data/mibs
    - onms_rrd:/opennms-data/rrd
    - onms_reports:/opennms-data/reports
    environment:
    - TZ=America/New_York
    - POSTGRES_HOST=database
    - POSTGRES_PORT=5432
    - POSTGRES_USER=postgres
    - POSTGRES_PASSWORD=postgres
    healthcheck:
      test: curl -f -I http://localhost:8980/opennms/login.jsp
      interval: 1m
      timeout: 5s
      retries: 3
 
  minion:
    container_name: minion
    hostname: minion
    image: opennms/minion:26.0.0
    depends_on:
    - kafka
    - opennms
    command: [ -c ]
    ports:
    - 8201:8201
    - 4444:4444/udp
    volumes:
    - ./minion.yaml:/opt/minion/minion-config.yaml
    environment:
    - TZ=America/New_York
    - OPENNMS_HTTP_USER=admin
    - OPENNMS_HTTP_PASS=admin
    healthcheck:
      test: /health.sh
      interval: 1m
      timeout: 5s
      retries: 3

  # Generate random numbers for heart rate and steps using NX-OS Telemetry Object
  generator:
    container_name: generator
    hostname: generator
    image: agalue/fhir-sample-generator
    depends_on:
    - minion
    environment:
    - TZ=America/New_York
    - TARGET=minion:4444
    - FREQUENCY=30s

  # Parses CollectionSets with health data sent by the Kafka Producer and forwards them to Azure Event Hub
  # Make sure to set FORWARDER_EVENT_HUB_CONNECTION_STR on your host prior start the environment
  forwarder:
    container_name: forwarder
    hostname: forwarder
    image: agalue/fhir-eventhub-forwarder
    depends_on:
    - opennms
    environment:
    - TZ=America/New_York
    - BOOTSTRAP_SERVERS=kafka:9092
    - SOURCE_TOPIC=metrics
    - GROUP_ID=forwarder
    - EVENT_HUB_CONNECTION_STR=${FORWARDER_EVENT_HUB_CONNECTION_STR:?}

